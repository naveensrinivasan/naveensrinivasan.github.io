<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="admin"><meta name=description content="In this post I will be demonstrating how we could use CLR internal data-structures to recursively get the methodtable’s of an object and its base classes. The idea behind this is to understand the CLR data structure.
Here is the sample code
[sourcecode language=”csharp”]
using System;
namespace ConsoleApplication
{
class Program : B
{
string test = &amp;ldquo;cw&amp;rdquo;;
static void Main(string[] args)
{
var p = new Program();
Console.Read();
}"><meta name=keywords content><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href="/?p=928/"><title>Recursive !dumpmt – Windbg :: naveen srinivasan — Write code.Loves to read</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.29c2c8c3fc9cf748254138351f142ac2833b208a68e83aec126edc98b59efef2.css><meta itemprop=name content="Recursive !dumpmt – Windbg"><meta itemprop=description content="In this post I will be demonstrating how we could use CLR internal data-structures to recursively get the methodtable’s of an object and its base classes. The idea behind this is to understand the CLR data structure.
Here is the sample code
[sourcecode language=”csharp”]
using System;
namespace ConsoleApplication
{
class Program : B
{
string test = &ldquo;cw&rdquo;;
static void Main(string[] args)
{
var p = new Program();
Console.Read();
}"><meta itemprop=datePublished content="2010-07-06T01:04:53+00:00"><meta itemprop=dateModified content="2010-07-06T01:04:53+00:00"><meta itemprop=wordCount content="654"><meta itemprop=image content="/"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/"><meta name=twitter:title content="Recursive !dumpmt – Windbg"><meta name=twitter:description content="In this post I will be demonstrating how we could use CLR internal data-structures to recursively get the methodtable’s of an object and its base classes. The idea behind this is to understand the CLR data structure.
Here is the sample code
[sourcecode language=”csharp”]
using System;
namespace ConsoleApplication
{
class Program : B
{
string test = &ldquo;cw&rdquo;;
static void Main(string[] args)
{
var p = new Program();
Console.Read();
}"><meta property="article:section" content="Windbg"><meta property="article:published_time" content="2010-07-06 01:04:53 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>cd /home</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/posts>posts</a></li><li><a href=/resume>resume</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href="/?p=928/">Recursive !dumpmt – Windbg</a></h2><div class=post-content><p>In this post I will be demonstrating how we could use CLR internal data-structures to recursively get the methodtable’s of an object and its base classes. The idea behind this is to understand the CLR data structure.</p><p>Here is the sample code</p><p>[sourcecode language=”csharp”]</p><p>using System;</p><p>namespace ConsoleApplication</p><p>{</p><p>class Program : B</p><p>{</p><p>string test = &ldquo;cw&rdquo;;</p><p>static void Main(string[] args)</p><p>{</p><p>var p = new Program();</p><p>Console.Read();</p><p>}</p><p>}</p><p>class B : A</p><p>{</p><p>public void TestB()</p><p>{</p><p>}</p><p>}</p><p>class A</p><p>{</p><p>public void TestA()</p><p>{</p><p>}</p><p>}</p><p>}</p><p>[/sourcecode]</p><p>The “Program” object address  is 0x0254bc38 and here  is the output of !dumpobj</p><blockquote><p>0:000> !do 0x0254bc38</p></blockquote><blockquote><p>Name:        ConsoleApplication.Program</p></blockquote><blockquote><p>MethodTable: 001c3904</p></blockquote><blockquote><p>EEClass:     001c1508</p></blockquote><blockquote><p>Size:        12(0xc) bytes</p></blockquote><blockquote><p>File:        C:UsersnaveenDocumentsVisual Studio 2010ProjectsConsoleApplication9binDebugConsoleApplication.exe</p></blockquote><blockquote><p>Fields:</p></blockquote><blockquote><p>MT    Field   Offset                 Type VT     Attr    Value Name</p></blockquote><blockquote><p>6335f9ac  4000001        4        System.String  0 instance 0254bc44 test</p></blockquote><p>The method table pointer for the Program class is 001c3904 . Let’s dump the raw memory instead of using !dumpobj</p><p>[sourcecode]</p><p>dd 0x0254bc38</p><p>[/sourcecode]</p><blockquote><p>0:000> dd 0x0254bc38</p></blockquote><blockquote><p>0254bc38  001c3904 0254bc44 80000000 6335f9ac</p></blockquote><blockquote><p>0254bc48  00000002 00770063 00000000 00000000</p></blockquote><blockquote><p>0254bc58  63367490 00000000 00000000 00000000</p></blockquote><blockquote><p>0254bc68  00000000 00000000 00000000 6335f5e8</p></blockquote><blockquote><p>0254bc78  00000000 40010000 63366034 00000003</p></blockquote><blockquote><p>0254bc88  00000008 00000100 00000000 63366f40</p></blockquote><blockquote><p>0254bc98  00000000 00000000 00000000 00000000</p></blockquote><blockquote><p>0254bca8  00000001 0254bc80 00000001 00000000</p></blockquote><p>Now that we can see the MethodTable pointer is the first field we can get the Methods by using</p><p>[sourcecode]</p><p>!dumpmt -md poi(0x0254bc38)</p><p>[/sourcecode]</p><blockquote><p>0:000> !dumpmt -md poi(0x0254bc38)</p></blockquote><blockquote><p>EEClass:      001c1508</p></blockquote><blockquote><p>Module:       001c2e9c</p></blockquote><blockquote><p>Name:         ConsoleApplication.Program</p></blockquote><blockquote><p>mdToken:      02000004</p></blockquote><blockquote><p>File:         C:UsersnaveenDocumentsVisual Studio 2010ProjectsConsoleApplication9binDebugConsoleApplication.exe</p></blockquote><blockquote><p>BaseSize:        0xc</p></blockquote><blockquote><p>ComponentSize:   0x0</p></blockquote><blockquote><p>Slots in VTable: 6</p></blockquote><blockquote><p>Number of IFaces in IFaceMap: 0</p></blockquote><blockquote><p>————————————–</p></blockquote><blockquote><p>MethodDesc Table</p></blockquote><blockquote><p>Entry MethodDesc      JIT Name</p></blockquote><blockquote><p>6326a7e0   63044934   PreJIT System.Object.ToString()</p></blockquote><blockquote><p>6326e2e0   6304493c   PreJIT System.Object.Equals(System.Object)</p></blockquote><blockquote><p>6326e1f0   6304495c   PreJIT System.Object.GetHashCode()</p></blockquote><blockquote><p>632f1600   63044970   PreJIT System.Object.Finalize()</p></blockquote><blockquote><p>002200d0   001c38f0      JIT ConsoleApplication.Program..ctor()</p></blockquote><blockquote><p>00220070   001c38e4      JIT ConsoleApplication.Program.Main(System.String[])</p></blockquote><p>So next time when we have an object we don’t have to go look for method table pointer address.</p><p>The goal is to get every method of class  Program, B, A and System.Object automatically. To get this, lets dump the raw memory of the method table</p><p>[sourcecode]</p><p>dd poi(0x0254bc38)</p><p>[/sourcecode]</p><blockquote><p>0:000> dd poi(0x0254bc38)</p></blockquote><blockquote><p>001c3904  00080000 0000000c 00050011 00000004</p></blockquote><blockquote><p>001c3914  001c3890 001c2e9c 001c3934 001c1508</p></blockquote><blockquote><p>001c3924  00000000 00000000 001c3854 002200d0</p></blockquote><blockquote><p>001c3934  00000080 00000000 00000000 00000000</p></blockquote><blockquote><p>001c3944  00000000 00000000 00000000 00000000</p></blockquote><blockquote><p>001c3954  00000000 00000000 00000000 00000000</p></blockquote><blockquote><p>001c3964  00000000 00000000 00000000 00000000</p></blockquote><blockquote><p>001c3974  00000000 00000000 00000000 00000000</p></blockquote><p>The 10th offset contains the address of its base class method table pointer, So in the above output it is 001c3890 .</p><p>Now that we know it is the 10th offset, here is the script to get every method table for a class and its parents. FYI if the 10th offset is 00000000 then it means it is the super class which is System.Object.</p><p>[sourcecode]</p><p>r$t0 =poi(0x0254bc38);.while(@$t0) {!dumpmt -md @$t0;.echo *<strong>*</strong>*<strong>*</strong>*****;r$t0=poi(@$t0+10)}</p><p>[/sourcecode]</p><p>And here is the explanation for the above script</p><ol><li>r$t0 =poi(0x0254bc38) – Using a pseudo register $t0 to assign the value of mt of the 0x0254bc38</li><li>The .while loop will terminate when the value is 0. The  “!dumpmt -md @$t0” will dump the Method Table of the $t0 and the  “r$t0=poi(@$t0+10)” will reset $t0 its parent object method table.</li></ol><p>Here is the partial output from the above script with method tables from Program and B</p><blockquote><p>0:000> r$t0 =poi(0x0254bc38);.while(@$t0) {!dumpmt -md @$t0;.echo *<strong>*</strong>*<strong>*</strong>*****;r$t0=poi(@$t0+10)}</p></blockquote><blockquote><p>EEClass:      001c1508</p></blockquote><blockquote><p>Module:       001c2e9c</p></blockquote><blockquote><p>Name:         ConsoleApplication.Program</p></blockquote><blockquote><p>mdToken:      02000004</p></blockquote><blockquote><p>File:         C:UsersnaveenDocumentsVisual Studio 2010ProjectsConsoleApplication9binDebugConsoleApplication.exe</p></blockquote><blockquote><p>BaseSize:        0xc</p></blockquote><blockquote><p>ComponentSize:   0x0</p></blockquote><blockquote><p>Slots in VTable: 6</p></blockquote><blockquote><p>Number of IFaces in IFaceMap: 0</p></blockquote><blockquote><p>————————————–</p></blockquote><blockquote><p>MethodDesc Table</p></blockquote><blockquote><p>Entry MethodDesc      JIT Name</p></blockquote><blockquote><p>6326a7e0   63044934   PreJIT System.Object.ToString()</p></blockquote><blockquote><p>6326e2e0   6304493c   PreJIT System.Object.Equals(System.Object)</p></blockquote><blockquote><p>6326e1f0   6304495c   PreJIT System.Object.GetHashCode()</p></blockquote><blockquote><p>632f1600   63044970   PreJIT System.Object.Finalize()</p></blockquote><blockquote><p>002200d0   001c38f0      JIT ConsoleApplication.Program..ctor()</p></blockquote><blockquote><p>00220070   001c38e4      JIT ConsoleApplication.Program.Main(System.String[])</p></blockquote><blockquote><p>*<strong>*</strong>*<strong>*</strong>*****</p></blockquote><blockquote><p>EEClass:      001c149c</p></blockquote><blockquote><p>Module:       001c2e9c</p></blockquote><blockquote><p>Name:         ConsoleApplication.B</p></blockquote><blockquote><p>mdToken:      02000003</p></blockquote><blockquote><p>File:         C:UsersnaveenDocumentsVisual Studio 2010ProjectsConsoleApplication9binDebugConsoleApplication.exe</p></blockquote><blockquote><p>BaseSize:        0xc</p></blockquote><blockquote><p>ComponentSize:   0x0</p></blockquote><blockquote><p>Slots in VTable: 6</p></blockquote><blockquote><p>Number of IFaces in IFaceMap: 0</p></blockquote><blockquote><p>————————————–</p></blockquote><blockquote><p>MethodDesc Table</p></blockquote><blockquote><p>Entry MethodDesc      JIT Name</p></blockquote><blockquote><p>6326a7e0   63044934   PreJIT System.Object.ToString()</p></blockquote><blockquote><p>6326e2e0   6304493c   PreJIT System.Object.Equals(System.Object)</p></blockquote><blockquote><p>6326e1f0   6304495c   PreJIT System.Object.GetHashCode()</p></blockquote><blockquote><p>632f1600   63044970   PreJIT System.Object.Finalize()</p></blockquote><blockquote><p>00220120   001c3888      JIT ConsoleApplication.B..ctor()</p></blockquote><blockquote><p>001cc02d   001c387c     NONE ConsoleApplication.B.TestB()</p></blockquote><blockquote><p>*<strong>*</strong>*<strong>*</strong>*****</p></blockquote></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class=tag><a href=/categories/windbg/>Windbg</a></span></p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.cf7fb2a9e24608a783e05e4472da2fdf008293289de1ad88d1cba5c143e7e414496dd33b6a228e92f8461ce0c8cbad3c9f9847e73e46dfbce0463393ddd1733a.js integrity="sha512-z3+yqeJGCKeD4F5Ectov3wCCkyid4a2I0culwUPn5BRJbdM7aiKOkvhGHODIy608n5hH5z5G37zgRjOT3dFzOg=="></script></body></html>