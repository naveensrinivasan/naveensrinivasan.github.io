<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="admin"><meta name=description content="I noticed someone who couldn’t figure out the cause of memory leak in managed application within the debugger. This person had basic debugging skills and was comfortable with sos. FYI the leak wasn’t in the managed code, but in the native code. The managed code was using native code via PInvoke.
Here is how I figured out the cause. Every time I have to debug a memory leak in managed code ,the first command I run is !"><meta name=keywords content><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href="/?p=868/"><title>Do I have Managed or Native memory leak? :: naveen srinivasan — Write code.Loves to read
</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.29c2c8c3fc9cf748254138351f142ac2833b208a68e83aec126edc98b59efef2.css><meta itemprop=name content="Do I have Managed or Native memory leak?"><meta itemprop=description content="I noticed someone who couldn’t figure out the cause of memory leak in managed application within the debugger. This person had basic debugging skills and was comfortable with sos. FYI the leak wasn’t in the managed code, but in the native code. The managed code was using native code via PInvoke.
Here is how I figured out the cause. Every time I have to debug a memory leak in managed code ,the first command I run is !"><meta itemprop=datePublished content="2010-06-22T22:38:52+00:00"><meta itemprop=dateModified content="2010-06-22T22:38:52+00:00"><meta itemprop=wordCount content="275"><meta itemprop=image content="/"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/"><meta name=twitter:title content="Do I have Managed or Native memory leak?"><meta name=twitter:description content="I noticed someone who couldn’t figure out the cause of memory leak in managed application within the debugger. This person had basic debugging skills and was comfortable with sos. FYI the leak wasn’t in the managed code, but in the native code. The managed code was using native code via PInvoke.
Here is how I figured out the cause. Every time I have to debug a memory leak in managed code ,the first command I run is !"><meta property="article:section" content="Windbg"><meta property="article:published_time" content="2010-06-22 22:38:52 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>cd /home</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/posts>posts</a></li><li><a href=/resume>resume</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href="/?p=868/">Do I have Managed or Native memory leak?</a></h2><div class=post-content><p>I noticed someone who couldn’t figure out the cause of memory leak in  managed application within the debugger. This person had basic debugging skills and was comfortable with sos.  FYI the leak wasn’t in the managed code, but in the native code. The managed code was using native code via PInvoke.</p><p>Here is how I figured out the cause. Every time I have to debug a memory leak in managed code ,the first command I run is !vmstat. The !vmstat is available in psscor2.dll for .net 3.5 and for .net 4.0 it is available in sos. This command provides summary of VM. The output is similar to the <a href=http://technet.microsoft.com/en-us/sysinternals/dd535533.aspx>VMMap</a> tool and here is the output from the command.</p><p><a href=http://104.197.135.42/wp-content/uploads/2010/06/vmstat1.jpg></a></p><p>Now that I know there is a memory leak, I always start of with running these commands</p><p>[sourcecode]</p><p>.shell -ci &ldquo;!EEHeap -loader&rdquo; findstr  &ldquo;LoaderHeap&rdquo;</p><p>.shell -ci &ldquo;!EEHeap -gc&rdquo; findstr /B &ldquo;Total Size&rdquo;</p><p>!heapstat  – iu</p><p>[/sourcecode]</p><p>And here is the output from the above commands</p><blockquote><p>0:004> .shell -ci “!EEHeap -loader” findstr  “LoaderHeap”</p></blockquote><blockquote><p>Total LoaderHeap size: 0x10000(65,536)bytes</p></blockquote><blockquote><p>.shell: Process exited</p></blockquote><blockquote><p>0:004> .shell -ci “!EEHeap -gc” findstr /B “Total Size”</p></blockquote><blockquote><p>Total Size   0x3df74(253,812)</p></blockquote><blockquote><p>.shell: Process exited</p></blockquote><blockquote><p>0:004> !heapstat -iu</p></blockquote><blockquote><p>Heap     Gen0         Gen1         Gen2         LOH</p></blockquote><blockquote><p>Heap0    8204         182020       54820        8768</p><p>Free space:                                                 Percentage</p></blockquote><blockquote><p>Heap0    12           149212       36           48          SOH: 60% LOH:  0%</p><p>Unrooted objects:                                           Percentage</p></blockquote><blockquote><p>Heap0    1188         0            0            0           SOH:  0% LOH:  0%</p></blockquote><blockquote><p>0:004></p></blockquote><p>And from the output I know there isn’t a managed memory leak. The total heap size is only 253,812 bytes and my loader heap is 65,536 bytes, so it has to be native code.  Now I can focus my efforts on the native code debugging.</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class=tag><a href=/categories/windbg/>Windbg</a></span></p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.ada905442d53eafc5c125b84cffce974e971bcb52433fb67db20c5af5b964cea37ebd2c16ee6457894372eac0911dd0428f88da966c8e885b160fc6c0fe0fed6.js integrity="sha512-rakFRC1T6vxcEluEz/zpdOlxvLUkM/tn2yDFr1uWTOo369LBbuZFeJQ3LqwJEd0EKPiNqWbI6IWxYPxsD+D+1g=="></script></body></html>