<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="admin"><meta name=description content="Recently I had to troubleshoot messages that were being sent from an web application hosted on IIS to an external authentication provider. The logs from the application wasn’t something closer to the metal and wasn’t really providing all the details. I really wanted something like fiddler for the webserver. I could have a ran network traces to troubleshoot the issue but the problem was it wasn’t happening consistently. It was sporadic. I knew there would be ETW traces that would have this information. The IIS web logs don’t capture this information.
"><meta name=keywords content=",ETW,IIS"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href="/?p=1510/"><title>View the http redirect and response message from an external authentication provider using ETW :: naveen srinivasan — Write code.Loves to read
</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.29c2c8c3fc9cf748254138351f142ac2833b208a68e83aec126edc98b59efef2.css><meta itemprop=name content="View the http redirect and response message from an external authentication provider using ETW"><meta itemprop=description content="Recently I had to troubleshoot messages that were being sent from an web application hosted on IIS to an external authentication provider. The logs from the application wasn’t something closer to the metal and wasn’t really providing all the details. I really wanted something like fiddler for the webserver. I could have a ran network traces to troubleshoot the issue but the problem was it wasn’t happening consistently. It was sporadic. I knew there would be ETW traces that would have this information. The IIS web logs don’t capture this information."><meta itemprop=datePublished content="2015-06-29T02:57:26+00:00"><meta itemprop=dateModified content="2015-06-29T02:57:26+00:00"><meta itemprop=wordCount content="298"><meta itemprop=image content="/"><meta itemprop=keywords content="ETW,IIS"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/"><meta name=twitter:title content="View the http redirect and response message from an external authentication provider using ETW"><meta name=twitter:description content="Recently I had to troubleshoot messages that were being sent from an web application hosted on IIS to an external authentication provider. The logs from the application wasn’t something closer to the metal and wasn’t really providing all the details. I really wanted something like fiddler for the webserver. I could have a ran network traces to troubleshoot the issue but the problem was it wasn’t happening consistently. It was sporadic. I knew there would be ETW traces that would have this information. The IIS web logs don’t capture this information."><meta property="article:section" content="ETW"><meta property="article:published_time" content="2015-06-29 02:57:26 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>cd /home</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/posts>posts</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href="/?p=1510/">View the http redirect and response message from an external authentication provider using ETW</a></h2><div class=post-content><p>Recently I had to troubleshoot messages that were being sent from an web application hosted on IIS to an external authentication provider. The logs from the application wasn’t something closer to the metal and wasn’t really providing all the details. I really wanted something like fiddler for the webserver. I could have a ran network traces to troubleshoot the issue but the problem was it wasn’t happening consistently. It was sporadic. I knew there would be ETW traces that would have this information. The IIS web logs don’t capture this information.</p><p>Here is a example of the SAML authentication process</p><p><a href=https://naveensrinivasan.files.wordpress.com/2015/06/500px-saml.jpg></a></p><p>In the application I was working with, IIS was the relying party and the user was to be authenticated with Identity Provider.</p><p>I wanted to troubleshoot the “AuthnRequest” and “Auth Resp” from and to the IIS. This can be applied to any external authentication like credit card authentication.</p><p>I fired my favorite tool Perfview and captured all the IIS traces along with other defaults. I wasn’t really interested in the .NET Code.</p><p>Here is the command line for Perfview to the IIS Providers</p><p>[gist id = “86a6d7daac73484ef504”]</p><p>If for some reason that does not work.  You could always use the additional providers in Perfview and add these providers which are IIS and HTTP providers.</p><p>[gist id = “5ac34bdd047d2d80cc44”]</p><p>I let perfview do its job and then stopped the trace when there was an issue.</p><p>Here are the ETW events that capture the SAML Request that was sent from IIS to the IDP</p><p>Event Name</p><ol><li>IIS_Trace/IISGeneral/GENERAL_RESPONSE_HEADERS</li><li>Microsoft-Windows-IIS/EventID(47)</li><li>IIS_Trace/IISGeneral/GENERAL_RESPONSE_ENTITY_BUFFER</li><li>Microsoft-Windows-IIS/EventID(49)</li><li>IIS_Trace/IISGeneral/GENERAL_REQUEST_HEADERS</li></ol><p><a href=https://naveensrinivasan.files.wordpress.com/2015/06/samlrequest.jpg></a></p><p>Here are the ETW events that capture the SAML Response that was being posted from the IDP to the IIS</p><ol><li>IIS_Trace/IISGeneral/GENERAL_REQUEST_ENTITY</li><li>Microsoft-Windows-IIS/EventID(51)</li></ol><p><a href=https://naveensrinivasan.files.wordpress.com/2015/06/samlresponse.jpg></a></p><p>With this I was able to troubleshoot message that was being sent and received to the IIS.</p><p> </p></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=/tags/etw/>ETW</a></span>
<span class=tag><a href=/tags/iis/>IIS</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
<span class=tag><a href=/categories/etw/>ETW</a></span></p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.63e1cd4087b02bc78961fcab2aaf77e957e2227557c73ab774f1cc4a9db0645e90d2403ca03e55eb0887e432e82aea10afe7f125052af6dd46cfea148ecbc663.js integrity="sha512-Y+HNQIewK8eJYfyrKq936VfiInVXxzq3dPHMSp2wZF6Q0kA8oD5V6wiH5DLoKuoQr+fxJQUq9t1Gz+oUjsvGYw=="></script></body></html>