<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="admin"><meta name=description content="I recently saw a stackoverflow question whereÂ someone wanted to know how they could correlate betweenÂ managed and native threads within Windbg.
Here is the managed thread object within the debugger
0:004&amp;gt; !do 02a1d6c4
Name:Â System.Threading.Thread
MethodTable: 672e001c
EEClass:Â 67018ed8
Size:Â 48(0x30) bytes
File:Â C:WindowsMicrosoft.NetassemblyGAC_32mscorlibv4.0_4.0.0.0__b77a5c561934e089mscorlib.dll
Fields:
MTÂ FieldÂ OffsetÂ Type VTÂ AttrÂ Value Name
672c8a78Â 4000720Â 4 â€¦.Contexts.ContextÂ 0 instance 00000000 m_Context
672db4b8Â 4000721Â 8 â€¦.ExecutionContextÂ 0 instance 00000000 m_ExecutionContext
672df9fcÂ 4000722Â cÂ System.StringÂ 0 instance 02a1a220 m_Name
672dfed0Â 4000723Â 10Â System.DelegateÂ 0 instance 00000000 m_Delegate
672e63f4Â 4000724Â 14 â€¦ation.CultureInfoÂ 0 instance 00000000 m_CurrentCulture
672e63f4Â 4000725Â 18 â€¦ation.CultureInfoÂ 0 instance 00000000 m_CurrentUICulture
672df638Â 4000726Â 1cÂ System.ObjectÂ 0 instance 00000000 m_ThreadStartArg
672daa7cÂ 4000727Â 20Â System.IntPtrÂ 1 instanceÂ 542560 DONT_USE_InternalThread
672e29c8Â 4000728Â 24Â System.Int32Â 1 instanceÂ 2 m_Priority
672e29c8Â 4000729Â 28Â System.Int32Â 1 instanceÂ 3 m_ManagedThreadId
672cb76cÂ 400072aÂ 18c â€¦LocalDataStoreMgrÂ 0Â sharedÂ static s_LocalDataStoreMgr
Domain:ValueÂ 0049f148:NotInitÂ &amp;laquo;
672ce328Â 400072bÂ c â€¦alDataStoreHolderÂ 0Â shared TLstatic s_LocalDataStore
Thread:Value &amp;laquo;
The present threadâ€™s @$teb (Thread Environment Block) is 7efac000
0:004&amp;gt; ? @$teb Evaluate expression: 2130374656 = 7efac000
The DONT_USE_InternalThread is pointer to the native thread. Dumping the raw memory of the pointer should give us more information we are looking for.
0:004&amp;gt; dd poi(02a1d6c4+20)
00542560Â 67e9ee88 0000b220 00000000 056ef42c
00542570Â 00000000 00000000 00000000 00000003
00542580Â 00000000 00542588 00542588 00542588
00542590Â 00000000 00000000 baad0000 004a4f30
005425a0Â 7efac000 baadf00d 00000000 00000000
005425b0Â 00024dac 00000000 00000000 00000000
005425c0Â 00000000 baadf00d 00541ba0 00544290
005425d0Â 00544298 00000200 00544290 00544580
The pointer to teb is in the 40th offset of theÂ DONT_USE_InternalThread and here is the script that would get teb for each managed thread.
[sourcecode]
.foreach ($thread {!dumpheap -mt 672e001c -short}) { .if ( poi(${$thread}+20) != 0) {.printf &amp;ldquo;%p n&amp;rdquo;,dwo(poi(${$thread}+20)+40)}}
[/sourcecode]
0:004&amp;gt; .foreach ($thread {!dumpheap -mt 672e001c -short}) { .if ( poi(${$thread}+20) != 0) {.printf â€œ%p nâ€,dwo(poi(${$thread}+20)+40) }}
7efdd000
7efac000
7ef9a000
7ef97000
7ef2f000
7ef26000
7efd7000
7ef20000
7ef1d000
7ef1d000
7ef0e000
7efa3000
7ef2c000
So with the above we could dump the teb structure using dt ntdll!_TEB command. In the next post I will demonstrate how this can be used to debug some cool stuff ğŸ™‚
"><meta name=keywords content><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href="/?p=1324/"><title>Correlating between .NET and native thread in Windbg :: naveen srinivasan â€” Write code.Loves to read
</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.29c2c8c3fc9cf748254138351f142ac2833b208a68e83aec126edc98b59efef2.css><meta itemprop=name content="Correlating between .NET and native thread in Windbg"><meta itemprop=description content="I recently saw a stackoverflow question whereÂ  someone wanted to know how they could correlate betweenÂ  managed and native threads within Windbg.
Here is the managed thread object within the debugger

0:004> !do 02a1d6c4


Name:Â Â Â Â Â Â Â  System.Threading.Thread


MethodTable: 672e001c


EEClass:Â Â Â Â  67018ed8


Size:Â Â Â Â Â Â Â  48(0x30) bytes


File:Â Â Â Â Â Â Â  C:WindowsMicrosoft.NetassemblyGAC_32mscorlibv4.0_4.0.0.0__b77a5c561934e089mscorlib.dll


Fields:


MTÂ Â Â  FieldÂ Â  OffsetÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Type VTÂ Â Â Â  AttrÂ Â Â  Value Name


672c8a78Â  4000720Â Â Â Â Â Â Â  4 â€¦.Contexts.ContextÂ  0 instance 00000000 m_Context


672db4b8Â  4000721Â Â Â Â Â Â Â  8 â€¦.ExecutionContextÂ  0 instance 00000000 m_ExecutionContext


672df9fcÂ  4000722Â Â Â Â Â Â Â  cÂ Â Â Â Â Â Â  System.StringÂ  0 instance 02a1a220 m_Name


672dfed0Â  4000723Â Â Â Â Â Â  10Â Â Â Â Â  System.DelegateÂ  0 instance 00000000 m_Delegate


672e63f4Â  4000724Â Â Â Â Â Â  14 â€¦ation.CultureInfoÂ  0 instance 00000000 m_CurrentCulture


672e63f4Â  4000725Â Â Â Â Â Â  18 â€¦ation.CultureInfoÂ  0 instance 00000000 m_CurrentUICulture


672df638Â  4000726Â Â Â Â Â Â  1cÂ Â Â Â Â Â Â  System.ObjectÂ  0 instance 00000000 m_ThreadStartArg


672daa7cÂ  4000727Â Â Â Â Â Â  20Â Â Â Â Â Â Â  System.IntPtrÂ  1 instanceÂ Â  542560 DONT_USE_InternalThread


672e29c8Â  4000728Â Â Â Â Â Â  24Â Â Â Â Â Â Â Â  System.Int32Â  1 instanceÂ Â Â Â Â Â Â  2 m_Priority


672e29c8Â  4000729Â Â Â Â Â Â  28Â Â Â Â Â Â Â Â  System.Int32Â  1 instanceÂ Â Â Â Â Â Â  3 m_ManagedThreadId


672cb76cÂ  400072aÂ Â Â Â Â  18c â€¦LocalDataStoreMgrÂ  0Â Â  sharedÂ Â  static s_LocalDataStoreMgr




Domain:ValueÂ  0049f148:NotInitÂ  &#171;




672ce328Â  400072bÂ Â Â Â Â Â Â  c â€¦alDataStoreHolderÂ  0Â Â  shared TLstatic s_LocalDataStore




Thread:Value &#171;



The present threadâ€™s @$teb (Thread Environment Block) is 7efac000
0:004> ? @$teb Evaluate expression: 2130374656 = 7efac000
The DONT_USE_InternalThread is pointer to the native thread. Dumping the raw memory of the pointer should give us more information we are looking for.

0:004> dd poi(02a1d6c4+20)


00542560Â  67e9ee88 0000b220 00000000 056ef42c


00542570Â  00000000 00000000 00000000 00000003


00542580Â  00000000 00542588 00542588 00542588


00542590Â  00000000 00000000 baad0000 004a4f30


005425a0Â  7efac000 baadf00d 00000000 00000000


005425b0Â  00024dac 00000000 00000000 00000000


005425c0Â  00000000 baadf00d 00541ba0 00544290


005425d0Â  00544298 00000200 00544290 00544580

The pointer to teb is in the 40th offset of theÂ  DONT_USE_InternalThread and here is the script that would get teb for each managed thread.
[sourcecode]
.foreach ($thread {!dumpheap -mt 672e001c -short}) { .if ( poi(${$thread}+20) != 0) {.printf &ldquo;%p n&rdquo;,dwo(poi(${$thread}+20)+40)}}
[/sourcecode]

0:004> .foreach ($thread {!dumpheap -mt 672e001c -short}) { .if ( poi(${$thread}+20) != 0) {.printf â€œ%p nâ€,dwo(poi(${$thread}+20)+40) }}


7efdd000


7efac000


7ef9a000


7ef97000


7ef2f000


7ef26000


7efd7000


7ef20000


7ef1d000


7ef1d000


7ef0e000


7efa3000


7ef2c000

So with the above we could dump the teb structure using dt ntdll!_TEB command. In the next post I will demonstrate how this can be used to debug some cool stuff ğŸ™‚"><meta itemprop=datePublished content="2011-01-09T01:46:06+00:00"><meta itemprop=dateModified content="2011-01-09T01:46:06+00:00"><meta itemprop=wordCount content="343"><meta itemprop=image content="/"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/"><meta name=twitter:title content="Correlating between .NET and native thread in Windbg"><meta name=twitter:description content="I recently saw a stackoverflow question whereÂ  someone wanted to know how they could correlate betweenÂ  managed and native threads within Windbg.
Here is the managed thread object within the debugger

0:004> !do 02a1d6c4


Name:Â Â Â Â Â Â Â  System.Threading.Thread


MethodTable: 672e001c


EEClass:Â Â Â Â  67018ed8


Size:Â Â Â Â Â Â Â  48(0x30) bytes


File:Â Â Â Â Â Â Â  C:WindowsMicrosoft.NetassemblyGAC_32mscorlibv4.0_4.0.0.0__b77a5c561934e089mscorlib.dll


Fields:


MTÂ Â Â  FieldÂ Â  OffsetÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Type VTÂ Â Â Â  AttrÂ Â Â  Value Name


672c8a78Â  4000720Â Â Â Â Â Â Â  4 â€¦.Contexts.ContextÂ  0 instance 00000000 m_Context


672db4b8Â  4000721Â Â Â Â Â Â Â  8 â€¦.ExecutionContextÂ  0 instance 00000000 m_ExecutionContext


672df9fcÂ  4000722Â Â Â Â Â Â Â  cÂ Â Â Â Â Â Â  System.StringÂ  0 instance 02a1a220 m_Name


672dfed0Â  4000723Â Â Â Â Â Â  10Â Â Â Â Â  System.DelegateÂ  0 instance 00000000 m_Delegate


672e63f4Â  4000724Â Â Â Â Â Â  14 â€¦ation.CultureInfoÂ  0 instance 00000000 m_CurrentCulture


672e63f4Â  4000725Â Â Â Â Â Â  18 â€¦ation.CultureInfoÂ  0 instance 00000000 m_CurrentUICulture


672df638Â  4000726Â Â Â Â Â Â  1cÂ Â Â Â Â Â Â  System.ObjectÂ  0 instance 00000000 m_ThreadStartArg


672daa7cÂ  4000727Â Â Â Â Â Â  20Â Â Â Â Â Â Â  System.IntPtrÂ  1 instanceÂ Â  542560 DONT_USE_InternalThread


672e29c8Â  4000728Â Â Â Â Â Â  24Â Â Â Â Â Â Â Â  System.Int32Â  1 instanceÂ Â Â Â Â Â Â  2 m_Priority


672e29c8Â  4000729Â Â Â Â Â Â  28Â Â Â Â Â Â Â Â  System.Int32Â  1 instanceÂ Â Â Â Â Â Â  3 m_ManagedThreadId


672cb76cÂ  400072aÂ Â Â Â Â  18c â€¦LocalDataStoreMgrÂ  0Â Â  sharedÂ Â  static s_LocalDataStoreMgr




Domain:ValueÂ  0049f148:NotInitÂ  &#171;




672ce328Â  400072bÂ Â Â Â Â Â Â  c â€¦alDataStoreHolderÂ  0Â Â  shared TLstatic s_LocalDataStore




Thread:Value &#171;



The present threadâ€™s @$teb (Thread Environment Block) is 7efac000
0:004> ? @$teb Evaluate expression: 2130374656 = 7efac000
The DONT_USE_InternalThread is pointer to the native thread. Dumping the raw memory of the pointer should give us more information we are looking for.

0:004> dd poi(02a1d6c4+20)


00542560Â  67e9ee88 0000b220 00000000 056ef42c


00542570Â  00000000 00000000 00000000 00000003


00542580Â  00000000 00542588 00542588 00542588


00542590Â  00000000 00000000 baad0000 004a4f30


005425a0Â  7efac000 baadf00d 00000000 00000000


005425b0Â  00024dac 00000000 00000000 00000000


005425c0Â  00000000 baadf00d 00541ba0 00544290


005425d0Â  00544298 00000200 00544290 00544580

The pointer to teb is in the 40th offset of theÂ  DONT_USE_InternalThread and here is the script that would get teb for each managed thread.
[sourcecode]
.foreach ($thread {!dumpheap -mt 672e001c -short}) { .if ( poi(${$thread}+20) != 0) {.printf &ldquo;%p n&rdquo;,dwo(poi(${$thread}+20)+40)}}
[/sourcecode]

0:004> .foreach ($thread {!dumpheap -mt 672e001c -short}) { .if ( poi(${$thread}+20) != 0) {.printf â€œ%p nâ€,dwo(poi(${$thread}+20)+40) }}


7efdd000


7efac000


7ef9a000


7ef97000


7ef2f000


7ef26000


7efd7000


7ef20000


7ef1d000


7ef1d000


7ef0e000


7efa3000


7ef2c000

So with the above we could dump the teb structure using dt ntdll!_TEB command. In the next post I will demonstrate how this can be used to debug some cool stuff ğŸ™‚"><meta property="article:section" content="Windbg"><meta property="article:published_time" content="2011-01-09 01:46:06 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>cd /home</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/posts>posts</a></li><li><a href=/resume>resume</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href="/?p=1324/">Correlating between .NET and native thread in Windbg</a></h2><div class=post-content><p>I recently saw a stackoverflow question whereÂ  someone wanted to know how they could correlate betweenÂ  managed and native threads within Windbg.</p><p>Here is the managed thread object within the debugger</p><blockquote><p>0:004> !do 02a1d6c4</p></blockquote><blockquote><p>Name:Â Â Â Â Â Â Â  System.Threading.Thread</p></blockquote><blockquote><p>MethodTable: 672e001c</p></blockquote><blockquote><p>EEClass:Â Â Â Â  67018ed8</p></blockquote><blockquote><p>Size:Â Â Â Â Â Â Â  48(0x30) bytes</p></blockquote><blockquote><p>File:Â Â Â Â Â Â Â  C:WindowsMicrosoft.NetassemblyGAC_32mscorlibv4.0_4.0.0.0__b77a5c561934e089mscorlib.dll</p></blockquote><blockquote><p>Fields:</p></blockquote><blockquote><p>MTÂ Â Â  FieldÂ Â  OffsetÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Type VTÂ Â Â Â  AttrÂ Â Â  Value Name</p></blockquote><blockquote><p>672c8a78Â  4000720Â Â Â Â Â Â Â  4 â€¦.Contexts.ContextÂ  0 instance 00000000 m_Context</p></blockquote><blockquote><p>672db4b8Â  4000721Â Â Â Â Â Â Â  8 â€¦.ExecutionContextÂ  0 instance 00000000 m_ExecutionContext</p></blockquote><blockquote><p>672df9fcÂ  4000722Â Â Â Â Â Â Â  cÂ Â Â Â Â Â Â  System.StringÂ  0 instance 02a1a220 m_Name</p></blockquote><blockquote><p>672dfed0Â  4000723Â Â Â Â Â Â  10Â Â Â Â Â  System.DelegateÂ  0 instance 00000000 m_Delegate</p></blockquote><blockquote><p>672e63f4Â  4000724Â Â Â Â Â Â  14 â€¦ation.CultureInfoÂ  0 instance 00000000 m_CurrentCulture</p></blockquote><blockquote><p>672e63f4Â  4000725Â Â Â Â Â Â  18 â€¦ation.CultureInfoÂ  0 instance 00000000 m_CurrentUICulture</p></blockquote><blockquote><p>672df638Â  4000726Â Â Â Â Â Â  1cÂ Â Â Â Â Â Â  System.ObjectÂ  0 instance 00000000 m_ThreadStartArg</p></blockquote><blockquote><p>672daa7cÂ  4000727Â Â Â Â Â Â  20Â Â Â Â Â Â Â  System.IntPtrÂ  1 instanceÂ Â  542560 DONT_USE_InternalThread</p></blockquote><blockquote><p>672e29c8Â  4000728Â Â Â Â Â Â  24Â Â Â Â Â Â Â Â  System.Int32Â  1 instanceÂ Â Â Â Â Â Â  2 m_Priority</p></blockquote><blockquote><p>672e29c8Â  4000729Â Â Â Â Â Â  28Â Â Â Â Â Â Â Â  System.Int32Â  1 instanceÂ Â Â Â Â Â Â  3 m_ManagedThreadId</p></blockquote><blockquote><p>672cb76cÂ  400072aÂ Â Â Â Â  18c â€¦LocalDataStoreMgrÂ  0Â Â  sharedÂ Â  static s_LocalDataStoreMgr</p></blockquote><blockquote><blockquote><blockquote><p>Domain:ValueÂ  0049f148:NotInitÂ  &#171;</p></blockquote></blockquote></blockquote><blockquote><p>672ce328Â  400072bÂ Â Â Â Â Â Â  c â€¦alDataStoreHolderÂ  0Â Â  shared TLstatic s_LocalDataStore</p></blockquote><blockquote><blockquote><blockquote><p>Thread:Value &#171;</p></blockquote></blockquote></blockquote><p>The present threadâ€™s @$teb (Thread Environment Block) is 7efac000</p><p>0:004> ? @$teb Evaluate expression: 2130374656 = 7efac000</p><p>The DONT_USE_InternalThread is pointer to the native thread. Dumping the raw memory of the pointer should give us more information we are looking for.</p><blockquote><p>0:004> dd poi(02a1d6c4+20)</p></blockquote><blockquote><p>00542560Â  67e9ee88 0000b220 00000000 056ef42c</p></blockquote><blockquote><p>00542570Â  00000000 00000000 00000000 00000003</p></blockquote><blockquote><p>00542580Â  00000000 00542588 00542588 00542588</p></blockquote><blockquote><p>00542590Â  00000000 00000000 baad0000 004a4f30</p></blockquote><blockquote><p>005425a0Â  7efac000 baadf00d 00000000 00000000</p></blockquote><blockquote><p>005425b0Â  00024dac 00000000 00000000 00000000</p></blockquote><blockquote><p>005425c0Â  00000000 baadf00d 00541ba0 00544290</p></blockquote><blockquote><p>005425d0Â  00544298 00000200 00544290 00544580</p></blockquote><p>The pointer to teb is in the 40th offset of theÂ  DONT_USE_InternalThread and here is the script that would get teb for each managed thread.</p><p>[sourcecode]</p><p>.foreach ($thread {!dumpheap -mt 672e001c -short}) { .if ( poi(${$thread}+20) != 0) {.printf &ldquo;%p n&rdquo;,dwo(poi(${$thread}+20)+40)}}</p><p>[/sourcecode]</p><blockquote><p>0:004> .foreach ($thread {!dumpheap -mt 672e001c -short}) { .if ( poi(${$thread}+20) != 0) {.printf â€œ%p nâ€,dwo(poi(${$thread}+20)+40) }}</p></blockquote><blockquote><p>7efdd000</p></blockquote><blockquote><p>7efac000</p></blockquote><blockquote><p>7ef9a000</p></blockquote><blockquote><p>7ef97000</p></blockquote><blockquote><p>7ef2f000</p></blockquote><blockquote><p>7ef26000</p></blockquote><blockquote><p>7efd7000</p></blockquote><blockquote><p>7ef20000</p></blockquote><blockquote><p>7ef1d000</p></blockquote><blockquote><p>7ef1d000</p></blockquote><blockquote><p>7ef0e000</p></blockquote><blockquote><p>7efa3000</p></blockquote><blockquote><p>7ef2c000</p></blockquote><p>So with the above we could dump the teb structure using dt ntdll!_TEB command. In the next post I will demonstrate how this can be used to debug some cool stuff ğŸ™‚</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class=tag><a href=/categories/windbg/>Windbg</a></span></p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.ada905442d53eafc5c125b84cffce974e971bcb52433fb67db20c5af5b964cea37ebd2c16ee6457894372eac0911dd0428f88da966c8e885b160fc6c0fe0fed6.js integrity="sha512-rakFRC1T6vxcEluEz/zpdOlxvLUkM/tn2yDFr1uWTOo369LBbuZFeJQ3LqwJEd0EKPiNqWbI6IWxYPxsD+D+1g=="></script></body></html>