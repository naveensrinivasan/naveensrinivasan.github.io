<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="admin"><meta name=description content="I recently saw a stackoverflow question where someone wanted to know how they could correlate between managed and native threads within Windbg.
Here is the managed thread object within the debugger
0:004&amp;gt; !do 02a1d6c4
Name: System.Threading.Thread
MethodTable: 672e001c
EEClass: 67018ed8
Size: 48(0x30) bytes
File: C:WindowsMicrosoft.NetassemblyGAC_32mscorlibv4.0_4.0.0.0__b77a5c561934e089mscorlib.dll
Fields:
MT Field Offset Type VT Attr Value Name
672c8a78 4000720 4 ….Contexts.Context 0 instance 00000000 m_Context
672db4b8 4000721 8 ….ExecutionContext 0 instance 00000000 m_ExecutionContext
672df9fc 4000722 c System.String 0 instance 02a1a220 m_Name
672dfed0 4000723 10 System.Delegate 0 instance 00000000 m_Delegate
672e63f4 4000724 14 …ation.CultureInfo 0 instance 00000000 m_CurrentCulture
672e63f4 4000725 18 …ation.CultureInfo 0 instance 00000000 m_CurrentUICulture
672df638 4000726 1c System.Object 0 instance 00000000 m_ThreadStartArg
672daa7c 4000727 20 System.IntPtr 1 instance 542560 DONT_USE_InternalThread
672e29c8 4000728 24 System.Int32 1 instance 2 m_Priority
672e29c8 4000729 28 System.Int32 1 instance 3 m_ManagedThreadId
672cb76c 400072a 18c …LocalDataStoreMgr 0 shared static s_LocalDataStoreMgr
Domain:Value 0049f148:NotInit &amp;laquo;
672ce328 400072b c …alDataStoreHolder 0 shared TLstatic s_LocalDataStore
Thread:Value &amp;laquo;
The present thread’s @$teb (Thread Environment Block) is 7efac000
0:004&amp;gt; ? @$teb Evaluate expression: 2130374656 = 7efac000
The DONT_USE_InternalThread is pointer to the native thread. Dumping the raw memory of the pointer should give us more information we are looking for.
0:004&amp;gt; dd poi(02a1d6c4+20)
00542560 67e9ee88 0000b220 00000000 056ef42c
00542570 00000000 00000000 00000000 00000003
00542580 00000000 00542588 00542588 00542588
00542590 00000000 00000000 baad0000 004a4f30
005425a0 7efac000 baadf00d 00000000 00000000
005425b0 00024dac 00000000 00000000 00000000
005425c0 00000000 baadf00d 00541ba0 00544290
005425d0 00544298 00000200 00544290 00544580
The pointer to teb is in the 40th offset of the DONT_USE_InternalThread and here is the script that would get teb for each managed thread.
[sourcecode]
.foreach ($thread {!dumpheap -mt 672e001c -short}) { .if ( poi(${$thread}+20) != 0) {.printf &amp;ldquo;%p n&amp;rdquo;,dwo(poi(${$thread}+20)+40)}}
[/sourcecode]
0:004&amp;gt; .foreach ($thread {!dumpheap -mt 672e001c -short}) { .if ( poi(${$thread}+20) != 0) {.printf “%p n”,dwo(poi(${$thread}+20)+40) }}
7efdd000
7efac000
7ef9a000
7ef97000
7ef2f000
7ef26000
7efd7000
7ef20000
7ef1d000
7ef1d000
7ef0e000
7efa3000
7ef2c000
So with the above we could dump the teb structure using dt ntdll!_TEB command. In the next post I will demonstrate how this can be used to debug some cool stuff 🙂
"><meta name=keywords content><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href="/?p=1324/"><title>Correlating between .NET and native thread in Windbg :: naveen srinivasan — Write code.Loves to read
</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.29c2c8c3fc9cf748254138351f142ac2833b208a68e83aec126edc98b59efef2.css><meta itemprop=name content="Correlating between .NET and native thread in Windbg"><meta itemprop=description content="I recently saw a stackoverflow question where  someone wanted to know how they could correlate between  managed and native threads within Windbg.
Here is the managed thread object within the debugger

0:004> !do 02a1d6c4


Name:        System.Threading.Thread


MethodTable: 672e001c


EEClass:     67018ed8


Size:        48(0x30) bytes


File:        C:WindowsMicrosoft.NetassemblyGAC_32mscorlibv4.0_4.0.0.0__b77a5c561934e089mscorlib.dll


Fields:


MT    Field   Offset                 Type VT     Attr    Value Name


672c8a78  4000720        4 ….Contexts.Context  0 instance 00000000 m_Context


672db4b8  4000721        8 ….ExecutionContext  0 instance 00000000 m_ExecutionContext


672df9fc  4000722        c        System.String  0 instance 02a1a220 m_Name


672dfed0  4000723       10      System.Delegate  0 instance 00000000 m_Delegate


672e63f4  4000724       14 …ation.CultureInfo  0 instance 00000000 m_CurrentCulture


672e63f4  4000725       18 …ation.CultureInfo  0 instance 00000000 m_CurrentUICulture


672df638  4000726       1c        System.Object  0 instance 00000000 m_ThreadStartArg


672daa7c  4000727       20        System.IntPtr  1 instance   542560 DONT_USE_InternalThread


672e29c8  4000728       24         System.Int32  1 instance        2 m_Priority


672e29c8  4000729       28         System.Int32  1 instance        3 m_ManagedThreadId


672cb76c  400072a      18c …LocalDataStoreMgr  0   shared   static s_LocalDataStoreMgr




Domain:Value  0049f148:NotInit  &#171;




672ce328  400072b        c …alDataStoreHolder  0   shared TLstatic s_LocalDataStore




Thread:Value &#171;



The present thread’s @$teb (Thread Environment Block) is 7efac000
0:004> ? @$teb Evaluate expression: 2130374656 = 7efac000
The DONT_USE_InternalThread is pointer to the native thread. Dumping the raw memory of the pointer should give us more information we are looking for.

0:004> dd poi(02a1d6c4+20)


00542560  67e9ee88 0000b220 00000000 056ef42c


00542570  00000000 00000000 00000000 00000003


00542580  00000000 00542588 00542588 00542588


00542590  00000000 00000000 baad0000 004a4f30


005425a0  7efac000 baadf00d 00000000 00000000


005425b0  00024dac 00000000 00000000 00000000


005425c0  00000000 baadf00d 00541ba0 00544290


005425d0  00544298 00000200 00544290 00544580

The pointer to teb is in the 40th offset of the  DONT_USE_InternalThread and here is the script that would get teb for each managed thread.
[sourcecode]
.foreach ($thread {!dumpheap -mt 672e001c -short}) { .if ( poi(${$thread}+20) != 0) {.printf &ldquo;%p n&rdquo;,dwo(poi(${$thread}+20)+40)}}
[/sourcecode]

0:004> .foreach ($thread {!dumpheap -mt 672e001c -short}) { .if ( poi(${$thread}+20) != 0) {.printf “%p n”,dwo(poi(${$thread}+20)+40) }}


7efdd000


7efac000


7ef9a000


7ef97000


7ef2f000


7ef26000


7efd7000


7ef20000


7ef1d000


7ef1d000


7ef0e000


7efa3000


7ef2c000

So with the above we could dump the teb structure using dt ntdll!_TEB command. In the next post I will demonstrate how this can be used to debug some cool stuff 🙂"><meta itemprop=datePublished content="2011-01-09T01:46:06+00:00"><meta itemprop=dateModified content="2011-01-09T01:46:06+00:00"><meta itemprop=wordCount content="343"><meta itemprop=image content="/"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/"><meta name=twitter:title content="Correlating between .NET and native thread in Windbg"><meta name=twitter:description content="I recently saw a stackoverflow question where  someone wanted to know how they could correlate between  managed and native threads within Windbg.
Here is the managed thread object within the debugger

0:004> !do 02a1d6c4


Name:        System.Threading.Thread


MethodTable: 672e001c


EEClass:     67018ed8


Size:        48(0x30) bytes


File:        C:WindowsMicrosoft.NetassemblyGAC_32mscorlibv4.0_4.0.0.0__b77a5c561934e089mscorlib.dll


Fields:


MT    Field   Offset                 Type VT     Attr    Value Name


672c8a78  4000720        4 ….Contexts.Context  0 instance 00000000 m_Context


672db4b8  4000721        8 ….ExecutionContext  0 instance 00000000 m_ExecutionContext


672df9fc  4000722        c        System.String  0 instance 02a1a220 m_Name


672dfed0  4000723       10      System.Delegate  0 instance 00000000 m_Delegate


672e63f4  4000724       14 …ation.CultureInfo  0 instance 00000000 m_CurrentCulture


672e63f4  4000725       18 …ation.CultureInfo  0 instance 00000000 m_CurrentUICulture


672df638  4000726       1c        System.Object  0 instance 00000000 m_ThreadStartArg


672daa7c  4000727       20        System.IntPtr  1 instance   542560 DONT_USE_InternalThread


672e29c8  4000728       24         System.Int32  1 instance        2 m_Priority


672e29c8  4000729       28         System.Int32  1 instance        3 m_ManagedThreadId


672cb76c  400072a      18c …LocalDataStoreMgr  0   shared   static s_LocalDataStoreMgr




Domain:Value  0049f148:NotInit  &#171;




672ce328  400072b        c …alDataStoreHolder  0   shared TLstatic s_LocalDataStore




Thread:Value &#171;



The present thread’s @$teb (Thread Environment Block) is 7efac000
0:004> ? @$teb Evaluate expression: 2130374656 = 7efac000
The DONT_USE_InternalThread is pointer to the native thread. Dumping the raw memory of the pointer should give us more information we are looking for.

0:004> dd poi(02a1d6c4+20)


00542560  67e9ee88 0000b220 00000000 056ef42c


00542570  00000000 00000000 00000000 00000003


00542580  00000000 00542588 00542588 00542588


00542590  00000000 00000000 baad0000 004a4f30


005425a0  7efac000 baadf00d 00000000 00000000


005425b0  00024dac 00000000 00000000 00000000


005425c0  00000000 baadf00d 00541ba0 00544290


005425d0  00544298 00000200 00544290 00544580

The pointer to teb is in the 40th offset of the  DONT_USE_InternalThread and here is the script that would get teb for each managed thread.
[sourcecode]
.foreach ($thread {!dumpheap -mt 672e001c -short}) { .if ( poi(${$thread}+20) != 0) {.printf &ldquo;%p n&rdquo;,dwo(poi(${$thread}+20)+40)}}
[/sourcecode]

0:004> .foreach ($thread {!dumpheap -mt 672e001c -short}) { .if ( poi(${$thread}+20) != 0) {.printf “%p n”,dwo(poi(${$thread}+20)+40) }}


7efdd000


7efac000


7ef9a000


7ef97000


7ef2f000


7ef26000


7efd7000


7ef20000


7ef1d000


7ef1d000


7ef0e000


7efa3000


7ef2c000

So with the above we could dump the teb structure using dt ntdll!_TEB command. In the next post I will demonstrate how this can be used to debug some cool stuff 🙂"><meta property="article:section" content="Windbg"><meta property="article:published_time" content="2011-01-09 01:46:06 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>cd /home</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/posts>posts</a></li><li><a href=/resume>resume</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href="/?p=1324/">Correlating between .NET and native thread in Windbg</a></h2><div class=post-content><p>I recently saw a stackoverflow question where  someone wanted to know how they could correlate between  managed and native threads within Windbg.</p><p>Here is the managed thread object within the debugger</p><blockquote><p>0:004> !do 02a1d6c4</p></blockquote><blockquote><p>Name:        System.Threading.Thread</p></blockquote><blockquote><p>MethodTable: 672e001c</p></blockquote><blockquote><p>EEClass:     67018ed8</p></blockquote><blockquote><p>Size:        48(0x30) bytes</p></blockquote><blockquote><p>File:        C:WindowsMicrosoft.NetassemblyGAC_32mscorlibv4.0_4.0.0.0__b77a5c561934e089mscorlib.dll</p></blockquote><blockquote><p>Fields:</p></blockquote><blockquote><p>MT    Field   Offset                 Type VT     Attr    Value Name</p></blockquote><blockquote><p>672c8a78  4000720        4 ….Contexts.Context  0 instance 00000000 m_Context</p></blockquote><blockquote><p>672db4b8  4000721        8 ….ExecutionContext  0 instance 00000000 m_ExecutionContext</p></blockquote><blockquote><p>672df9fc  4000722        c        System.String  0 instance 02a1a220 m_Name</p></blockquote><blockquote><p>672dfed0  4000723       10      System.Delegate  0 instance 00000000 m_Delegate</p></blockquote><blockquote><p>672e63f4  4000724       14 …ation.CultureInfo  0 instance 00000000 m_CurrentCulture</p></blockquote><blockquote><p>672e63f4  4000725       18 …ation.CultureInfo  0 instance 00000000 m_CurrentUICulture</p></blockquote><blockquote><p>672df638  4000726       1c        System.Object  0 instance 00000000 m_ThreadStartArg</p></blockquote><blockquote><p>672daa7c  4000727       20        System.IntPtr  1 instance   542560 DONT_USE_InternalThread</p></blockquote><blockquote><p>672e29c8  4000728       24         System.Int32  1 instance        2 m_Priority</p></blockquote><blockquote><p>672e29c8  4000729       28         System.Int32  1 instance        3 m_ManagedThreadId</p></blockquote><blockquote><p>672cb76c  400072a      18c …LocalDataStoreMgr  0   shared   static s_LocalDataStoreMgr</p></blockquote><blockquote><blockquote><blockquote><p>Domain:Value  0049f148:NotInit  &#171;</p></blockquote></blockquote></blockquote><blockquote><p>672ce328  400072b        c …alDataStoreHolder  0   shared TLstatic s_LocalDataStore</p></blockquote><blockquote><blockquote><blockquote><p>Thread:Value &#171;</p></blockquote></blockquote></blockquote><p>The present thread’s @$teb (Thread Environment Block) is 7efac000</p><p>0:004> ? @$teb Evaluate expression: 2130374656 = 7efac000</p><p>The DONT_USE_InternalThread is pointer to the native thread. Dumping the raw memory of the pointer should give us more information we are looking for.</p><blockquote><p>0:004> dd poi(02a1d6c4+20)</p></blockquote><blockquote><p>00542560  67e9ee88 0000b220 00000000 056ef42c</p></blockquote><blockquote><p>00542570  00000000 00000000 00000000 00000003</p></blockquote><blockquote><p>00542580  00000000 00542588 00542588 00542588</p></blockquote><blockquote><p>00542590  00000000 00000000 baad0000 004a4f30</p></blockquote><blockquote><p>005425a0  7efac000 baadf00d 00000000 00000000</p></blockquote><blockquote><p>005425b0  00024dac 00000000 00000000 00000000</p></blockquote><blockquote><p>005425c0  00000000 baadf00d 00541ba0 00544290</p></blockquote><blockquote><p>005425d0  00544298 00000200 00544290 00544580</p></blockquote><p>The pointer to teb is in the 40th offset of the  DONT_USE_InternalThread and here is the script that would get teb for each managed thread.</p><p>[sourcecode]</p><p>.foreach ($thread {!dumpheap -mt 672e001c -short}) { .if ( poi(${$thread}+20) != 0) {.printf &ldquo;%p n&rdquo;,dwo(poi(${$thread}+20)+40)}}</p><p>[/sourcecode]</p><blockquote><p>0:004> .foreach ($thread {!dumpheap -mt 672e001c -short}) { .if ( poi(${$thread}+20) != 0) {.printf “%p n”,dwo(poi(${$thread}+20)+40) }}</p></blockquote><blockquote><p>7efdd000</p></blockquote><blockquote><p>7efac000</p></blockquote><blockquote><p>7ef9a000</p></blockquote><blockquote><p>7ef97000</p></blockquote><blockquote><p>7ef2f000</p></blockquote><blockquote><p>7ef26000</p></blockquote><blockquote><p>7efd7000</p></blockquote><blockquote><p>7ef20000</p></blockquote><blockquote><p>7ef1d000</p></blockquote><blockquote><p>7ef1d000</p></blockquote><blockquote><p>7ef0e000</p></blockquote><blockquote><p>7efa3000</p></blockquote><blockquote><p>7ef2c000</p></blockquote><p>So with the above we could dump the teb structure using dt ntdll!_TEB command. In the next post I will demonstrate how this can be used to debug some cool stuff 🙂</p></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg><span class=tag><a href=/categories/windbg/>Windbg</a></span></p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.ada905442d53eafc5c125b84cffce974e971bcb52433fb67db20c5af5b964cea37ebd2c16ee6457894372eac0911dd0428f88da966c8e885b160fc6c0fe0fed6.js integrity="sha512-rakFRC1T6vxcEluEz/zpdOlxvLUkM/tn2yDFr1uWTOo369LBbuZFeJQ3LqwJEd0EKPiNqWbI6IWxYPxsD+D+1g=="></script></body></html>