<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="ie=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=author content="admin">
<meta name=description content="In this post I am going to unravel the mystery of debugging the Nullablewithin Windbg in .NET 3.5 and also compare it with .NET 4.0. Here is the sample code and it is compiled in .NET 3.5
[sourcecode language=”csharp”]
using System;
namespace ConsoleApplication
{
class Program
{
Int32? test;
int i = 10;
static void Main(string[] args)
{
NullableInt32? i = 10;
Object o = 10;
var p = new Program() { test = 20 };">
<meta name=keywords content>
<meta name=robots content="noodp">
<meta name=theme-color content>
<link rel=canonical href="/?p=947/">
<title>
Debugging Generic System.Nullable within Windbg :: naveen srinivasan — Write code.Loves to read
</title>
<link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css>
<link rel=stylesheet href=/main.29c2c8c3fc9cf748254138351f142ac2833b208a68e83aec126edc98b59efef2.css>
<meta itemprop=name content="Debugging Generic System.Nullable within Windbg">
<meta itemprop=description content="In this post I am going to unravel the mystery of debugging the Nullablewithin Windbg in .NET 3.5 and also compare it with .NET 4.0. Here is the sample code and it is compiled in .NET 3.5
[sourcecode language=”csharp”]
using System;
namespace ConsoleApplication
{
class Program
{
Int32? test;
int i = 10;
static void Main(string[] args)
{
NullableInt32? i = 10;
Object o = 10;
var p = new Program() { test = 20 };"><meta itemprop=datePublished content="2010-07-08T03:58:51+00:00">
<meta itemprop=dateModified content="2010-07-08T03:58:51+00:00">
<meta itemprop=wordCount content="697"><meta itemprop=image content="/">
<meta itemprop=keywords content>
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="/">
<meta name=twitter:title content="Debugging Generic System.Nullable within Windbg">
<meta name=twitter:description content="In this post I am going to unravel the mystery of debugging the Nullablewithin Windbg in .NET 3.5 and also compare it with .NET 4.0. Here is the sample code and it is compiled in .NET 3.5
[sourcecode language=”csharp”]
using System;
namespace ConsoleApplication
{
class Program
{
Int32? test;
int i = 10;
static void Main(string[] args)
{
NullableInt32? i = 10;
Object o = 10;
var p = new Program() { test = 20 };">
<meta property="article:section" content="SOS">
<meta property="article:section" content="SOSEX">
<meta property="article:section" content="Windbg">
<meta property="article:published_time" content="2010-07-08 03:58:51 +0000 UTC">
</head>
<body>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=/ style=text-decoration:none>
<div class=logo>
<span class=logo__mark>></span>
<span class=logo__text>cd /home</span>
<span class=logo__cursor>
</span>
</div>
</a>
<span class=header__right>
<nav class=menu>
<ul class=menu__inner><li><a href=/posts>posts</a></li>
</ul>
</nav>
<span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<main class=post>
<div class=post-info>
</p>
</div>
<article>
<h2 class=post-title><a href="/?p=947/">Debugging Generic System.Nullable within Windbg</a></h2>
<div class=post-content>
<p>In this post I am going to unravel the mystery of debugging the Nullable within Windbg in .NET 3.5 and also compare it with .NET 4.0. Here is the sample code and it is compiled in .NET 3.5</p>
<p>[sourcecode language=”csharp”]</p>
<p>using System;</p>
<p>namespace ConsoleApplication</p>
<p>{</p>
<p>class Program</p>
<p>{</p>
<p>Int32? test;</p>
<p>int i = 10;</p>
<p>static void Main(string[] args)</p>
<p>{</p>
<p>Nullable</p>
<p>Int32? i = 10;</p>
<p>Object o = 10;</p>
<p>var p = new Program() { test = 20 };</p>
<p>Console.Read();</p>
<p>p.test = (Int32?) o ;</p>
<p>Console.WriteLine(p.test.HasValue);</p>
<p>}</p>
<p>}</p>
<p>}</p>
<p>[/sourcecode]</p>
<p>Attached to the debugger on the Console.Read. FYI I always load sos and sosex extensions to debug managed code. Here is !mdt 0x0253c11c output</p>
<blockquote>
<p>0:000> !mdt 0x0253c11c</p>
</blockquote>
<blockquote>
<p>0253c11c (ConsoleApplication.Program)</p>
</blockquote>
<blockquote>
<p>test:ERROR (0x80070057).</p>
</blockquote>
<blockquote>
<p>i:0xa (System.Int32)</p>
</blockquote>
<p>Notice that “test” does not have a value and has an error. Next issued !dumpobj</p>
<p>[sourcecode]</p>
<p>!do 0x0253c11c</p>
<p>[/sourcecode]</p>
<blockquote>
<p>0:000> !do 0x0253c11c</p>
</blockquote>
<blockquote>
<p>Name: ConsoleApplication.Program</p>
</blockquote>
<blockquote>
<p>MethodTable: 002932f0</p>
</blockquote>
<blockquote>
<p>EEClass: 00291360</p>
</blockquote>
<blockquote>
<p>Size: 20(0x14) bytes</p>
</blockquote>
<blockquote>
<p>(C:UsersnaveenDocumentsVisual Studio 2010ProjectsConsoleApplication9binDebugConsoleApplication.exe)</p>
</blockquote>
<blockquote>
<p>Fields:</p>
</blockquote>
<blockquote>
<p>MT    Field   Offset                 Type VT     Attr    Value Name</p>
</blockquote>
<blockquote>
<p>00000000 4000001        8                       1 instance 0280c124 test</p>
</blockquote>
<blockquote>
<p>7776ab0c  4000002        4         System.Int32  1 instance       10 i</p>
</blockquote>
<p>My fault ,I thought sos should be able to get the MethodTable of Nullable for “test” when sosex couldn’t.  To my surprise the MT output was 00000000 . To view the contents of the “test” I would have to use  the !dumpvc which requires methodtable. I know I could use the dd command. And here is the output from the dd 0280c124</p>
<blockquote>
<p>0:000> dd 0280c124</p>
</blockquote>
<blockquote>
<p>0280c124  00000001 00000014 00000000 77767c70</p>
</blockquote>
<blockquote>
<p>0280c134  00000000 00000000 00000000 00000000</p>
</blockquote>
<blockquote>
<p>0280c144  00000000 00000000 777684dc 00000000</p>
</blockquote>
<blockquote>
<p>0280c154  40010000 7776d7ec 00000003 00000008</p>
</blockquote>
<blockquote>
<p>0280c164  00000100 00000000 77767cc4 00000000</p>
</blockquote>
<blockquote>
<p>0280c174  00000000 00000000 00000000 00000001</p>
</blockquote>
<blockquote>
<p>0280c184  0280c158 00000001 00000000 7776841c</p>
</blockquote>
<blockquote>
<p>0280c194  00000000 00000000 00000000 00000000</p>
</blockquote>
<p>The second field 00000014 is the actual value of test and here is the actual output</p>
<blockquote>
<p>0:000> ? poi(0280c124+0x4)</p>
</blockquote>
<blockquote>
<p>Evaluate expression: 20 = 00000014</p>
</blockquote>
<p>But this does not solve the real issue of figuring out the methodtable to use it in !dumpvc. I could have used !mx System.Nullable* to get the MethodTable,  because I knew the type is Nullable ,what if I didn’t know the type information.</p>
<p>To get the mt information I had to disassemble the code. First step is to get the !clrstack</p>
<blockquote>
<p>0:000> !CLRStack</p>
</blockquote>
<blockquote>
<p>OS Thread Id: 0x94c (0)</p>
</blockquote>
<blockquote>
<p>ESP       EIP</p>
</blockquote>
<blockquote>
<p>0021f1dc 769d73ea [NDirectMethodFrameStandaloneCleanup: 0021f1dc] System.IO.__ConsoleStream.ReadFile(Microsoft.Win32.SafeHandles.SafeFileHandle, Byte*, Int32, Int32 ByRef, IntPtr)</p>
</blockquote>
<blockquote>
<p>0021f1f8 77c8ae67 System.IO.__ConsoleStream.ReadFileNative(Microsoft.Win32.SafeHandles.SafeFileHandle, Byte[], Int32, Int32, Int32, Int32 ByRef)</p>
</blockquote>
<blockquote>
<p>0021f224 77c8ad86 System.IO.__ConsoleStream.Read(Byte[], Int32, Int32)</p>
</blockquote>
<blockquote>
<p>0021f244 776f9fbb System.IO.StreamReader.ReadBuffer()</p>
</blockquote>
<blockquote>
<p>0021f258 77c677fc System.IO.StreamReader.Read()</p>
</blockquote>
<blockquote>
<p>0021f264 77c8dd81 System.IO.TextReader+SyncTextReader.Read()</p>
</blockquote>
<blockquote>
<p>0021f270 77bd328b System.Console.Read()</p>
</blockquote>
<blockquote>
<p>0021f278 00320115 ConsoleApplication.Program.Main(System.String[])</p>
</blockquote>
<blockquote>
<p>0021f4d0 59781b6c [GCFrame: 0021f4d0]</p>
</blockquote>
<p>The next is to !u 00320115 and here is the partial ouput</p>
<blockquote>
<p>00320116 8b45d8          mov     eax,dword ptr [ebp-28h]</p>
</blockquote>
<blockquote>
<p>00320119 3a4008          cmp     al,byte ptr [eax+8]</p>
</blockquote>
<blockquote>
<p>0032011c 8d4008          lea     eax,[eax+8]</p>
</blockquote>
<blockquote>
<p>0032011f 8945c8          mov     dword ptr [ebp-38h],eax</p>
</blockquote>
<blockquote>
<p>00320122 ff75dc          push    dword ptr [ebp-24h]</p>
</blockquote>
<blockquote>
<p>00320125 8b4dc8          mov     ecx,dword ptr [ebp-38h]</p>
</blockquote>
<blockquote>
<p>00320128 bae8397777      mov     edx,offset mscorlib_ni+0x2739e8 (777739e8) (MT: System.Nullable`1[[System.Int32, mscorlib]])</p>
</blockquote>
<blockquote>
<p>0032012d e8d6a74c59      call    mscorwks!JIT_Unbox_Nullable (597ea908)</p>
</blockquote>
<p>Notice the Method table 777739e8 for System.Nullable`1[[System.Int32, mscorlib]] and here is the output from !dumpmt -md 777739e8</p>
<blockquote>
<p>0:000> !dumpmt -md 777739e8</p>
</blockquote>
<blockquote>
<p>EEClass: 7752e7c8</p>
</blockquote>
<blockquote>
<p>Module: 77501000</p>
</blockquote>
<blockquote>
<p>Name: System.Nullable`1[[System.Int32, mscorlib]]</p>
</blockquote>
<blockquote>
<p>mdToken: 0200026d  (C:WindowsassemblyGAC_32mscorlib2.0.0.0__b77a5c561934e089mscorlib.dll)</p>
</blockquote>
<blockquote>
<p>BaseSize: 0x10</p>
</blockquote>
<blockquote>
<p>ComponentSize: 0x0</p>
</blockquote>
<blockquote>
<p>Number of IFaces in IFaceMap: 0</p>
</blockquote>
<blockquote>
<p>Slots in VTable: 14</p>
</blockquote>
<blockquote>
<p>————————————–</p>
</blockquote>
<blockquote>
<p>MethodDesc Table</p>
</blockquote>
<blockquote>
<p>Entry MethodDesc      JIT Name</p>
</blockquote>
<blockquote>
<p>77697028   775eace0     NONE System.Nullable`1[[System.Int32, mscorlib]].ToString()</p>
</blockquote>
<blockquote>
<p>77697020   775eacc0     NONE System.Nullable`1[[System.Int32, mscorlib]].Equals(System.Object)</p>
</blockquote>
<blockquote>
<p>77697018   775eacd0     NONE System.Nullable`1[[System.Int32, mscorlib]].GetHashCode()</p>
</blockquote>
<blockquote>
<p>777374c0   775412a4   PreJIT System.Object.Finalize()</p>
</blockquote>
<blockquote>
<p>77d010a0   775eac98   PreJIT System.Nullable`1[[System.Int32, mscorlib]]..ctor(Int32)</p>
</blockquote>
<blockquote>
<p>77d01100   775eaca0   PreJIT System.Nullable`1[[System.Int32, mscorlib]].get_HasValue()</p>
</blockquote>
<blockquote>
<p>77d01120   775eaca8   PreJIT System.Nullable`1[[System.Int32, mscorlib]].get_Value()</p>
</blockquote>
<blockquote>
<p>77d01030   775eacb0   PreJIT System.Nullable`1[[System.Int32, mscorlib]].GetValueOrDefault()</p>
</blockquote>
<blockquote>
<p>77d01140   775eacb8   PreJIT System.Nullable`1[[System.Int32, mscorlib]].GetValueOrDefault(Int32)</p>
</blockquote>
<blockquote>
<p>77d0100c   775eacf0   PreJIT System.Nullable`1[[System.Int32, mscorlib]].op_Implicit(Int32)</p>
</blockquote>
<blockquote>
<p>77d00fe8   775eacf8   PreJIT System.Nullable`1[[System.Int32, mscorlib]].op_Explicit(System.Nullable`1)</p>
</blockquote>
<blockquote>
<p>77d01040   775eacc8   PreJIT System.Nullable`1[[System.Int32, mscorlib]].Equals(System.Object)</p>
</blockquote>
<blockquote>
<p>77d01078   775eacd8   PreJIT System.Nullable`1[[System.Int32, mscorlib]].GetHashCode()</p>
</blockquote>
<blockquote>
<p>77d010c0   775eace8   PreJIT System.Nullable`1[[System.Int32, mscorlib]].ToString()</p>
</blockquote>
<p>Now that I have confirmed the mt and here is the output from !dumpvc 777739e8 0280c124</p>
<blockquote>
<p>0:000> !dumpvc 777739e8 0280c124</p>
</blockquote>
<blockquote>
<p>Name: System.Nullable`1[[System.Int32, mscorlib]]</p>
</blockquote>
<blockquote>
<p>MethodTable 777739e8</p>
</blockquote>
<blockquote>
<p>EEClass: 7752e7c8</p>
</blockquote>
<blockquote>
<p>Size: 16(0x10) bytes</p>
</blockquote>
<blockquote>
<p>(C:WindowsassemblyGAC_32mscorlib2.0.0.0__b77a5c561934e089mscorlib.dll)</p>
</blockquote>
<blockquote>
<p>Fields:</p>
</blockquote>
<blockquote>
<p>MT    Field   Offset                 Type VT     Attr    Value Name</p>
</blockquote>
<blockquote>
<p>7776eadc  40009a8        0       System.Boolean  1 instance        1 hasValue</p>
</blockquote>
<blockquote>
<p>7776ab0c  40009a9        4         System.Int32  1 instance       20 value</p>
</blockquote>
<p>I decided to test this in .NET 4.0 and here is the output of !mdt for the Program object</p>
<blockquote>
<p>0:000> !mdt 0x0236bc44</p>
</blockquote>
<blockquote>
<p>0236bc44 (ConsoleApplication.Program)</p>
</blockquote>
<blockquote>
<p>test:(System.Nullable`1[[System.Int32, mscorlib]]) VALTYPE (MT=6229f60c, ADDR=0236bc50)</p>
</blockquote>
<blockquote>
<p>i:0xa (System.Int32)</p>
</blockquote>
<p>Notice the “test” which is Nullable is now recognized by sosex and it also provides the method table.</p>
</div>
</article>
<hr>
<div class=post-info>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
<span class=tag><a href=/categories/sos/>SOS</a></span>
<span class=tag><a href=/categories/sosex/>SOSEX</a></span>
<span class=tag><a href=/categories/windbg/>Windbg</a></span>
</p>
</div>
</main>
</div>
<footer class=footer>
</footer>
</div>
<script type=text/javascript src=/bundle.min.599099f1f14b78b657d524b28e10e0c5098e7cd46e9c7aed73d577068a276c3ff1bb234cbf29cb313333e83cf411727b43157c91ce5b809e2ffc81664614608e.js integrity="sha512-WZCZ8fFLeLZX1SSyjhDgxQmOfNRunHrtc9V3BoonbD/xuyNMvynLMTMz6Dz0EXJ7QxV8kc5bgJ4v/IFmRhRgjg=="></script>
</body>
</html>